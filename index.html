<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Audioguide AI Player & Editor</title>
    <style>
        :root {
            --primary: #c62828;
            --primary-light: #ffcdd2;
            --surface: #ffffff;
            --background: #f3f4f6;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --radius: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background);
            color: var(--text-dark);
            padding-bottom: 180px;
        }

        /* --- LOGICA EDITING MODE --- */
        .edit-mode-only { display: none !important; }
        body.is-editing .edit-mode-only { display: flex !important; }
        
        @media (min-width: 1024px) {
            .edit-mode-only { display: flex !important; }
            .edit-toggle-container { display: none; }
        }

        /* --- HEADER --- */
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            box-shadow: var(--shadow-sm);
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        h1 { margin: 0; font-size: 1.25rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        
        .btn-icon {
            background: var(--background); border: none; width: 40px; height: 40px;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; transition: transform 0.2s;
        }

        .search-bar { position: relative; width: 100%; }
        .search-bar input {
            width: 100%; padding: 12px 15px 12px 40px; border: none; background: #e2e8f0;
            border-radius: var(--radius); font-size: 1rem; outline: none;
        }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5; }

        /* --- CONTROLLI FILE --- */
        .file-controls {
            padding: 10px 15px; display: flex; gap: 10px; overflow-x: auto; white-space: nowrap;
        }
        
        .chip {
            background: white; border: 1px solid #cbd5e1; padding: 8px 16px; border-radius: 20px;
            font-size: 0.9rem; font-weight: 600; color: var(--text-dark); cursor: pointer;
            display: flex; align-items: center; gap: 6px; box-shadow: var(--shadow-sm);
        }
        .chip.active { background: var(--text-dark); color: white; border-color: var(--text-dark); }
        .chip.save-btn { background: #166534; color: white; border-color: #166534; }
        .chip input[type=file] { display: none; }

        /* --- LISTA TRACCE (Card ottimizzate) --- */
        .container { max-width: 800px; margin: 0 auto; padding: 10px 15px; }
        
        .track-card {
            background: var(--surface); border-radius: var(--radius); padding: 0;
            margin-bottom: 12px; box-shadow: var(--shadow-sm); cursor: pointer;
            transition: all 0.2s ease; border-left: 5px solid transparent;
            position: relative; overflow: hidden; display: flex; align-items: stretch;
            min-height: 110px;
        }

        .track-card.active { border-left-color: var(--primary); background: #fffafa; box-shadow: var(--shadow-md); }

        .track-img-container {
            width: 110px; min-width: 110px; height: auto;
            background: #eee; display: block;
        }
        .track-img { width: 100%; height: 100%; object-fit: cover; }
        
        .track-content { padding: 12px; flex-grow: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }

        .track-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px; }
        .track-title { font-weight: 700; font-size: 1rem; line-height: 1.2; color: var(--text-dark); }
        .track-duration { font-size: 0.7rem; background: #eee; padding: 2px 6px; border-radius: 4px; color: #555; }

        .track-author { font-size: 0.85rem; color: var(--primary); font-weight: 500; margin-bottom: 4px; }
        .track-desc { font-size: 0.85rem; color: var(--text-light); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .edit-track-btn {
            position: absolute; top: 8px; right: 8px;
            background: white; border: 1px solid #ddd;
            border-radius: 50%; width: 30px; height: 30px;
            display: flex; align-items: center; justify-content: center; z-index: 10;
        }

        /* --- PLAYER BAR (Mobile Friendly) --- */
        .player-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); 
            padding: 15px 20px 30px 20px; z-index: 500; border-radius: 20px 20px 0 0;
        }
        
        .np-info { text-align: center; margin-bottom: 10px; }
        .np-title { font-size: 1rem; font-weight: bold; color: var(--primary); }

        .player-controls-main { display: flex; align-items: center; justify-content: center; gap: 25px; margin-top: 10px; }
        .btn-player { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--text-dark); }
        .btn-play-pause { 
            background: var(--primary); color: white; width: 55px; height: 55px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; 
        }

        audio { width: 100%; height: 30px; margin-top: 15px; opacity: 0.6; }

        /* --- MODALI --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-box { background: white; width: 100%; max-width: 500px; border-radius: 20px; padding: 20px; max-height: 80vh; overflow-y: auto; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        .input-group input, .input-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
        .btn-primary { background: var(--text-dark); color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <h1>üèõÔ∏è AudioGuide AI</h1>
        <div style="display: flex; gap: 8px;">
            <button class="btn-icon edit-mode-only" onclick="window.app.openTool()">‚ú®</button>
            <button class="btn-icon" onclick="document.body.classList.toggle('is-editing')">üõ†Ô∏è</button>
        </div>
    </div>
    <div class="search-bar">
        <span class="search-icon">üîç</span>
        <input type="text" placeholder="Cerca opera..." oninput="window.app.search(this.value)">
    </div>
</header>

<div class="file-controls">
    <div class="chip active" onclick="window.app.loadDemo()">üì± Demo</div>
    <label class="chip edit-mode-only">üìÇ Carica JSON <input type="file" accept=".json" onchange="window.app.loadLocalJson(this)"></label>
    <div class="chip save-btn edit-mode-only" onclick="window.app.downloadJson()">üíæ Esporta</div>
</div>

<div class="container" id="trackList"></div>

<div class="player-bar">
    <div class="np-info">
        <div id="npTitle" class="np-title">Seleziona una traccia</div>
    </div>
    
    <div class="player-controls-main">
        <button class="btn-player" onclick="document.getElementById('audioPlayer').currentTime -= 10">‚è™</button>
        <button class="btn-player btn-play-pause" id="playBtn" onclick="window.app.togglePlay()">‚ñ∂Ô∏è</button>
        <button class="btn-player" onclick="document.getElementById('audioPlayer').currentTime += 10">‚è©</button>
    </div>
    
    <audio id="audioPlayer" controlslist="nodownload"></audio>
</div>

<div id="editorModal" class="modal-overlay">
    <div class="modal-box">
        <h3>Modifica Traccia</h3>
        <input type="hidden" id="editId">
        <div class="input-group"><label>Immagine (URL o Base64)</label><input type="text" id="editImg"></div>
        <div class="input-group"><label>Titolo</label><input type="text" id="editTitle"></div>
        <div class="input-group"><label>Autore</label><input type="text" id="editAuthor"></div>
        <div class="input-group"><label>Descrizione</label><textarea id="editDesc" rows="3"></textarea></div>
        <button class="btn-primary" onclick="window.app.saveTrack()">Salva</button>
        <button class="btn-primary" style="background:#eee; color:#333; margin-top:8px;" onclick="document.getElementById('editorModal').style.display='none'">Chiudi</button>
    </div>
</div>

<script>
    const DEMO_DATA = {
        title: "Galleria dell'Accademia",
        mp3File: "audio.mp3",
        tracks: [
            { id: 1, title: "Introduzione", author: "Guida", start: "00:00", end: "00:46", desc: "Benvenuti alla Galleria dell'Accademia di Firenze.", image: "https://images.unsplash.com/photo-1594142340571-08573267926c?auto=format&fit=crop&w=300&q=80" },
            { id: 2, title: "Ratto delle Sabine", author: "Giambologna", start: "00:48", end: "01:28", desc: "Modello in terra cruda al centro della Sala del Colosso.", image: "https://images.unsplash.com/photo-1620121692029-d088224ddc74?auto=format&fit=crop&w=300&q=80" }
        ]
    };

    window.app = {
        currentData: null,
        activeEndSec: null,

        init: function() {
            this.loadDemo();
            const player = document.getElementById('audioPlayer');
            const playBtn = document.getElementById('playBtn');
            
            player.addEventListener('timeupdate', () => {
                if (this.activeEndSec && player.currentTime >= this.activeEndSec) {
                    player.pause();
                    this.activeEndSec = null;
                }
            });

            player.onplay = () => playBtn.textContent = '‚è∏Ô∏è';
            player.onpause = () => playBtn.textContent = '‚ñ∂Ô∏è';
        },

        loadDemo: function() { this.renderGuide(JSON.parse(JSON.stringify(DEMO_DATA))); },

        loadLocalJson: function(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => this.renderGuide(JSON.parse(e.target.result));
            reader.readAsText(file);
        },

        renderGuide: function(data) {
            this.currentData = data;
            const list = document.getElementById('trackList');
            const player = document.getElementById('audioPlayer');
            
            if (data.mp3File && !player.src.endsWith(data.mp3File)) player.src = data.mp3File;
            
            list.innerHTML = '';
            data.tracks.forEach(track => {
                const el = document.createElement('div');
                el.className = 'track-card';
                el.id = `track-${track.id}`;
                el.innerHTML = `
                    <div class="track-img-container">
                        <img src="${track.image || ''}" class="track-img" onerror="this.src='https://via.placeholder.com/150?text=No+Img'">
                    </div>
                    <div class="track-content" onclick="window.app.playTrack(${track.id})">
                        <div class="track-header">
                            <span class="track-title">${track.title}</span>
                            <span class="track-duration">${track.start}</span>
                        </div>
                        <div class="track-author">${track.author || ''}</div>
                        <div class="track-desc">${track.desc}</div>
                    </div>
                    <button class="edit-track-btn edit-mode-only" onclick="window.app.openEditor(${track.id})">‚úèÔ∏è</button>
                `;
                list.appendChild(el);
            });
        },

        playTrack: function(id) {
            const track = this.currentData.tracks.find(t => t.id === id);
            if(!track) return;
            const player = document.getElementById('audioPlayer');
            
            this.activeEndSec = this.toSec(track.end);
            player.currentTime = this.toSec(track.start);
            player.play();
            
            document.getElementById('npTitle').textContent = track.title;
            document.querySelectorAll('.track-card').forEach(c => c.classList.remove('active'));
            document.getElementById(`track-${id}`).classList.add('active');
        },

        togglePlay: function() {
            const p = document.getElementById('audioPlayer');
            if (p.paused) p.play(); else p.pause();
        },

        openEditor: function(id) {
            const track = this.currentData.tracks.find(t => t.id === id);
            document.getElementById('editId').value = id;
            document.getElementById('editTitle').value = track.title;
            document.getElementById('editAuthor').value = track.author || '';
            document.getElementById('editDesc').value = track.desc;
            document.getElementById('editImg').value = track.image || '';
            document.getElementById('editorModal').style.display = 'flex';
        },

        saveTrack: function() {
            const id = parseInt(document.getElementById('editId').value);
            const idx = this.currentData.tracks.findIndex(t => t.id === id);
            if (idx > -1) {
                this.currentData.tracks[idx].title = document.getElementById('editTitle').value;
                this.currentData.tracks[idx].author = document.getElementById('editAuthor').value;
                this.currentData.tracks[idx].desc = document.getElementById('editDesc').value;
                this.currentData.tracks[idx].image = document.getElementById('editImg').value;
                this.renderGuide(this.currentData);
                document.getElementById('editorModal').style.display = 'none';
            }
        },

        downloadJson: function() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.currentData, null, 2));
            const a = document.createElement('a');
            a.href = dataStr; a.download = "guida.json"; a.click();
        },

        toSec: function(str) { const p = str.split(':'); return parseInt(p[0]) * 60 + parseInt(p[1]); },
        search: function(q) {
            const term = q.toLowerCase();
            document.querySelectorAll('.track-card').forEach((card, i) => {
                const t = this.currentData.tracks[i];
                card.style.display = (t.title.toLowerCase().includes(term) || (t.author && t.author.toLowerCase().includes(term))) ? 'flex' : 'none';
            });
        }
    };

    window.app.init();
</script>

</body>
</html>
