<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Audioguide AI Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-apple: #007aff;
            --background-light: #f2f2f7; /* Grigio chiarissimo Apple */
            --surface-card: #ffffff;
            --text-dark: #1c1c1e;
            --text-light: #8e8e93;
            --border-light: rgba(0,0,0,0.1);
            --radius-lg: 14px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; 
            font-family: -apple-system, system-ui, sans-serif;
            background-color: var(--background-light);
            color: var(--text-dark);
            padding-bottom: 180px;
        }

        .edit-mode-only { display: none !important; }
        body.is-editing .edit-mode-only { display: flex !important; }

        /* --- HEADER --- */
        header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            padding: 15px 20px;
            position: sticky;
            top: 0; z-index: 100;
            border-bottom: 1px solid var(--border-light);
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 700; letter-spacing: -0.5px; }
        
        .btn-icon {
            background: #e5e5ea; border: none; width: 38px; height: 38px;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1rem; color: var(--text-dark); transition: 0.2s;
        }

        /* --- CARD LIST --- */
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        
        .track-card {
            background: var(--surface-card); border-radius: var(--radius-lg);
            margin-bottom: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; overflow: hidden;
            transition: transform 0.2s; border: 1px solid var(--border-light);
        }

        .track-card:active { transform: scale(0.98); }

        /* Fix Immagini: "Buchi" eliminati con altezza fissa e cover */
        .track-img-container {
            width: 100%; height: 200px; /* Altezza fissa per un look editoriale */
            background: #d1d1d6;
        }
        .track-img { width: 100%; height: 100%; object-fit: cover; }
        
        .track-content { padding: 16px; }
        .track-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .track-title { font-weight: 600; font-size: 1.1rem; }
        .track-duration { font-size: 0.8rem; color: var(--primary-apple); font-weight: 600; }
        .track-author { font-size: 0.9rem; color: var(--text-light); margin-bottom: 8px; }
        .track-desc { font-size: 0.9rem; line-height: 1.4; color: #3a3a3c; }

        /* --- PLAYER --- */
        .player-bar {
            position: fixed; bottom: 0; width: 100%;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
            padding: 20px; border-top: 1px solid var(--border-light);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        .np-title { text-align: center; font-weight: 600; margin-bottom: 15px; font-size: 0.95rem; }
        .player-controls { display: flex; justify-content: center; align-items: center; gap: 30px; }
        .play-btn { 
            width: 60px; height: 60px; background: var(--text-dark); color: white; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
        }

        /* --- MODAL ESPLORA --- */
        #exploreModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .explore-content { background: white; width: 90%; max-width: 400px; border-radius: 20px; padding: 20px; }
        .guide-option { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; font-weight: 500; }
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <h1>Audioguide AI</h1>
        <div style="display: flex; gap: 10px;">
            <button class="btn-icon" onclick="window.app.toggleExplore()" title="Esplora Guide"><i class="fas fa-compass"></i></button>
            <button class="btn-icon" onclick="document.body.classList.toggle('is-editing')"><i class="fas fa-tools"></i></button>
        </div>
    </div>
</header>

<div class="file-controls">
    <label class="chip edit-mode-only" style="margin-left:20px;"><i class="fas fa-plus"></i> Importa JSON <input type="file" accept=".json" onchange="window.app.loadLocalJson(this)"></label>
</div>

<div class="container" id="trackList">
    <div style="text-align:center; padding-top:50px; color:#8e8e93;">Caricamento catalogo...</div>
</div>

<div class="player-bar">
    <div id="npTitle" class="np-title">Pronto all'ascolto</div>
    <div class="player-controls">
        <button class="btn-icon" onclick="document.getElementById('audioPlayer').currentTime -= 10"><i class="fas fa-undo"></i></button>
        <div class="play-btn" id="playBtn" onclick="window.app.togglePlay()"><i class="fas fa-play"></i></div>
        <button class="btn-icon" onclick="document.getElementById('audioPlayer').currentTime += 10"><i class="fas fa-redo"></i></button>
    </div>
    <audio id="audioPlayer" style="display:none;"></audio>
</div>

<div id="exploreModal" onclick="window.app.toggleExplore()">
    <div class="explore-content" onclick="event.stopPropagation()">
        <h3 style="margin-top:0">Catalogo Guide</h3>
        <div id="guideList"></div>
        <button class="btn-primary" style="margin-top:15px; background:#eee; color:#333; border:none; padding:10px; width:100%; border-radius:10px;" onclick="window.app.toggleExplore()">Chiudi</button>
    </div>
</div>

<script>
    // Configura qui l'URL del tuo file indice su GitHub (usando raw.githubusercontent.com)
    const CATALOG_URL = 'index.json'; 

    window.app = {
        catalog: [],
        currentData: null,
        player: null,

        init: async function() {
            this.player = document.getElementById('audioPlayer');
            await this.loadCatalog();
            this.setupPlayerEvents();
        },

        loadCatalog: async function() {
            try {
                // Se sei in locale usa il file index.json, se sei online usa l'URL assoluto
                const response = await fetch(CATALOG_URL);
                this.catalog = await response.json();
                this.renderCatalogMenu();
                this.loadRandomGuide();
            } catch (e) {
                console.error("Errore caricamento catalogo:", e);
                // Fallback se il file index non esiste ancora
                document.getElementById('trackList').innerHTML = "Configura 'index.json' nel repository.";
            }
        },

        renderCatalogMenu: function() {
            const container = document.getElementById('guideList');
            container.innerHTML = this.catalog.map(g => `
                <div class="guide-option" onclick="window.app.fetchGuide('${g.url}')">
                    <i class="fas fa-map-marker-alt" style="color:#007aff; margin-right:10px;"></i> ${g.title}
                </div>
            `).join('');
        },

        loadRandomGuide: function() {
            if (this.catalog.length > 0) {
                const randomIdx = Math.floor(Math.random() * this.catalog.length);
                this.fetchGuide(this.catalog[randomIdx].url);
            }
        },

        fetchGuide: async function(url) {
            try {
                const response = await fetch(url);
                const data = await response.json();
                this.renderGuide(data);
                document.getElementById('exploreModal').style.display = 'none';
            } catch (e) { alert("Errore nel caricamento della guida selezionata."); }
        },

        renderGuide: function(data) {
            this.currentData = data;
            this.player.src = data.mp3File;
            const container = document.getElementById('trackList');
            container.innerHTML = data.tracks.map(t => `
                <div class="track-card" id="track-${t.id}">
                    <div class="track-img-container">
                        <img src="${t.image}" class="track-img" onerror="this.src='https://images.unsplash.com/photo-1579546678183-a84ee76d7d02?q=80&w=1000&auto=format&fit=crop'">
                    </div>
                    <div class="track-content" onclick="window.app.playTrack(${t.id})">
                        <div class="track-header">
                            <span class="track-title">${t.title}</span>
                            <span class="track-duration">${t.start}</span>
                        </div>
                        <div class="track-author">${t.author}</div>
                        <div class="track-desc">${t.desc}</div>
                    </div>
                </div>
            `).join('');
        },

        playTrack: function(id) {
            const track = this.currentData.tracks.find(t => t.id === id);
            this.activeEndSec = this.toSec(track.end);
            this.player.currentTime = this.toSec(track.start);
            this.player.play();
            document.getElementById('npTitle').textContent = track.title;
        },

        togglePlay: function() {
            if (this.player.paused) this.player.play(); else this.player.pause();
        },

        setupPlayerEvents: function() {
            const btn = document.getElementById('playBtn');
            this.player.onplay = () => btn.innerHTML = '<i class="fas fa-pause"></i>';
            this.player.onpause = () => btn.innerHTML = '<i class="fas fa-play"></i>';
            this.player.addEventListener('timeupdate', () => {
                if (this.activeEndSec && this.player.currentTime >= this.activeEndSec) this.player.pause();
            });
        },

        toggleExplore: function() {
            const m = document.getElementById('exploreModal');
            m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
        },

        toSec: function(str) { const p = str.split(':'); return parseInt(p[0]) * 60 + parseInt(p[1]); }
    };

    window.app.init();
</script>
</body>
</html>
