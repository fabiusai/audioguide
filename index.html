<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Audioguide AI Pro</title>
    <link rel="icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="audioguide.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-apple: #007aff;
            --background-light: #f2f2f7;
            --surface-card: #ffffff;
            --text-dark: #1c1c1e;
            --text-medium: #48484a;
            --text-light: #8e8e93;
            --border-light: rgba(0,0,0,0.08);
            --radius-lg: 20px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; font-family: -apple-system, system-ui, sans-serif;
            background-color: var(--background-light); color: var(--text-dark);
            padding-bottom: 220px; -webkit-font-smoothing: antialiased;
        }

        .edit-mode-only { display: none !important; }
        body.is-editing .edit-mode-only { display: flex !important; }

        /* --- HEADER & SEARCH --- */
        .sticky-nav {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255, 255, 255, 0.8); backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--border-light);
        }
        header { padding: 15px 20px 10px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 700; letter-spacing: -0.5px; }

        .search-container { padding: 0 20px 15px; }
        .search-wrapper {
            position: relative; background: rgba(118, 118, 128, 0.12);
            border-radius: 10px; display: flex; align-items: center; padding: 8px 12px;
        }
        .search-wrapper i { color: var(--text-light); margin-right: 8px; }
        .search-wrapper input {
            border: none; background: transparent; width: 100%; outline: none;
            font-size: 1rem; color: var(--text-dark);
        }

        .btn-icon {
            background: #e5e5ea; border: none; width: 36px; height: 36px;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
            color: var(--text-dark); transition: 0.2s;
        }

        /* --- ROOM HEADERS (NUOVO) --- */
        .room-group { margin-bottom: 10px; }
        .room-header {
            padding: 20px 5px 10px 5px;
            font-size: 0.9rem; font-weight: 800; color: var(--text-light);
            text-transform: uppercase; letter-spacing: 1px;
            display: flex; align-items: center; gap: 8px;
        }
        .room-header i { color: var(--primary-apple); }

        /* --- CARD LIST --- */
        .container { max-width: 500px; margin: 0 auto; padding: 15px; }
        
        .track-card {
            background: var(--surface-card); border-radius: var(--radius-lg);
            margin-bottom: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.06);
            overflow: hidden; border: 1px solid var(--border-light);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .track-card:active { transform: scale(0.97); }
        .track-card.active { border: 2px solid var(--primary-apple); }

        .track-img-container { width: 100%; height: 320px; background: #d1d1d6; overflow: hidden; }
        .track-img { width: 100%; height: 100%; object-fit: cover; object-position: top; }
        
        .track-content { padding: 16px; display: flex; justify-content: space-between; align-items: center; }
        .track-info-text { flex-grow: 1; }
        .track-title { font-weight: 700; font-size: 1.1rem; margin: 0; letter-spacing: -0.3px; }
        
        .track-author { 
            font-size: 0.95rem; color: var(--text-medium); margin-top: 4px; font-weight: 500; 
            display: flex; align-items: center; gap: 8px;
        }
        
        /* Badge sala dentro la card (opzionale) */
        .badge-room {
            font-size: 0.7rem; background: #f2f2f7; color: var(--text-light);
            padding: 2px 6px; border-radius: 4px; font-weight: 600; text-transform: uppercase;
        }
        
        .track-duration { font-size: 0.8rem; font-weight: 600; color: var(--primary-apple); }

        /* --- PLAYER --- */
        .player-bar {
            position: fixed; bottom: 0; width: 100%;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(25px);
            padding: 20px 25px 40px; border-top: 1px solid var(--border-light);
            z-index: 500;
        }
        .np-title { text-align: center; font-weight: 600; font-size: 0.9rem; margin-bottom: 15px; }
        .player-controls { display: flex; justify-content: center; align-items: center; gap: 35px; }
        .play-btn { 
            width: 65px; height: 65px; background: var(--text-dark); color: white; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;
        }

        /* --- MODALS --- */
        .modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); 
            z-index: 1000; align-items: flex-end;
        }
        .modal-sheet {
            background: white; width: 100%; border-radius: 24px 24px 0 0;
            padding: 25px; transform: translateY(100%); transition: transform 0.3s ease-out;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-overlay.active { display: flex; }
        .modal-overlay.active .modal-sheet { transform: translateY(0); }

        .input-group { margin-bottom: 18px; }
        .input-group label { display: block; font-size: 0.75rem; font-weight: 700; color: var(--text-light); margin-bottom: 6px; text-transform: uppercase; }
        .input-group input, .input-group textarea {
            width: 100%; padding: 14px; border: none; background: #f2f2f7; border-radius: 12px; font-size: 1rem;
        }
        .btn-main { background: var(--primary-apple); color: white; border: none; padding: 16px; width: 100%; border-radius: 14px; font-weight: 700; cursor: pointer; }
    </style>
</head>
<body>

<div class="sticky-nav">
    <header>
        <div class="header-top">
            <h1>Audioguide AI <span style="font-size:0.5em; opacity:0.6; vertical-align:middle; background:#eee; padding:2px 5px; border-radius:4px;">v1.1</span></h1>
            <div style="display: flex; gap: 12px;">
                <button class="btn-icon edit-mode-only" style="background: #fff9c4;" onclick="window.app.openPromptTool()"><i class="fas fa-sparkles"></i></button>
                <button class="btn-icon" onclick="window.app.toggleExplore()"><i class="fas fa-compass"></i></button>
                <button class="btn-icon" onclick="document.body.classList.toggle('is-editing')"><i class="fas fa-pencil-alt"></i></button>
            </div>
        </div>
    </header>
    <div class="search-container">
        <div class="search-wrapper">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Cerca opera o autore..." oninput="window.app.search(this.value)">
        </div>
    </div>
</div>

<div class="container" id="trackList"></div>

<div class="player-bar">
    <div id="npTitle" class="np-title">Scegli un'opera</div>
    <div class="player-controls">
        <button class="btn-icon" style="background:none" onclick="document.getElementById('audioPlayer').currentTime -= 10"><i class="fas fa-undo-alt fa-lg"></i></button>
        <div class="play-btn" id="playBtn" onclick="window.app.togglePlay()"><i class="fas fa-play"></i></div>
        <button class="btn-icon" style="background:none" onclick="document.getElementById('audioPlayer').currentTime += 10"><i class="fas fa-redo-alt fa-lg"></i></button>
    </div>
    <audio id="audioPlayer" style="display:none;"></audio>
</div>

<div id="promptModal" class="modal-overlay" onclick="window.app.closeModals()">
    <div class="modal-sheet" onclick="event.stopPropagation()">
        <h3 style="margin-top:0">✨ AI Studio</h3>
        
        <div style="display:flex; gap:10px; margin-bottom:20px; background:#f2f2f7; padding:4px; border-radius:12px;">
            <button onclick="window.app.switchTab('create')" id="tabCreate" style="flex:1; border:none; background:white; padding:10px; border-radius:9px; font-weight:700; box-shadow:0 2px 5px rgba(0,0,0,0.05); cursor:pointer;">1. Scrivi Testi</button>
            <button onclick="window.app.switchTab('extract')" id="tabExtract" style="flex:1; border:none; background:transparent; padding:10px; border-radius:9px; font-weight:700; color:#8e8e93; cursor:pointer;">2. Estrai JSON</button>
        </div>

        <div id="viewCreate">
            <p style="font-size:0.85rem; color:#666; margin-bottom:15px;">Genera i testi con i marcatori corretti ("Titolo opera", "Fine descrizione") per il TTS.</p>
            <div class="input-group"><label>Argomento / Museo</label><input type="text" id="gTopic" placeholder="es. Galleria Palatina"></div>
            <div class="input-group"><label>Stile & Lunghezza</label>
                <select id="gStyle" style="width:100%; padding:14px; border:none; background:#f2f2f7; border-radius:12px; font-size:1rem;">
                    <option value="breve e conciso (circa 150 parole per opera)">Breve (Essenziale)</option>
                    <option value="coinvolgente e di media lunghezza (circa 300 parole per opera)" selected>Medio (Standard)</option>
                    <option value="molto dettagliato e accademico (circa 600 parole per opera)">Lungo (Approfondito)</option>
                </select>
            </div>
            <div class="input-group"><label>Elenco Opere (Opzionale)</label><textarea id="gList" rows="3" placeholder="Elenca le opere o lascia vuoto..."></textarea></div>
            <button class="btn-main" onclick="window.app.generateScript()">Copia Prompt Scrittura</button>
        </div>

        <div id="viewExtract" style="display:none;">
            <p style="font-size:0.85rem; color:#666; margin-bottom:15px;">Incolla qui la trascrizione di Turboscribe (con i timestamp) per generare il JSON finale.</p>
            <div class="input-group"><label>Titolo Guida</label><input type="text" id="pTitle"></div>
            <div class="input-group"><label>Testo Sorgente (Turboscribe)</label><textarea id="pTranscript" rows="5"></textarea></div>
            <button class="btn-main" onclick="window.app.generatePrompt()">Copia Prompt JSON</button>
        </div>
    </div>
</div>
<script>
    // Iniezione funzioni AI Studio al caricamento
    window.addEventListener('load', () => {
        window.app.switchTab = function(mode) {
            const create = mode === 'create';
            document.getElementById('viewCreate').style.display = create ? 'block' : 'none';
            document.getElementById('viewExtract').style.display = create ? 'none' : 'block';
            
            const t1 = document.getElementById('tabCreate');
            const t2 = document.getElementById('tabExtract');
            t1.style.background = create ? 'white' : 'transparent';
            t1.style.boxShadow = create ? '0 2px 5px rgba(0,0,0,0.05)' : 'none';
            t1.style.color = create ? 'black' : '#8e8e93';
            
            t2.style.background = !create ? 'white' : 'transparent';
            t2.style.boxShadow = !create ? '0 2px 5px rgba(0,0,0,0.05)' : 'none';
            t2.style.color = !create ? 'black' : '#8e8e93';
        };

        window.app.generateScript = function() {
            const topic = document.getElementById('gTopic').value || "Museo";
            const style = document.getElementById('gStyle').value;
            const list = document.getElementById('gList').value;
            
            const prompt = `Agisci come esperto creatore di audioguide. Scrivi i testi per: ${topic}.
Stile: ${style}.
${list ? 'Opere richieste: ' + list : 'Seleziona le opere principali.'}

IMPORTANTE: FORMATTAZIONE RIGIDA PER TTS E PARSING
Non usare Markdown (niente grassetti o elenchi puntati). Usa testo puro.
Devi usare ESATTAMENTE questi marcatori testuali per permettere al software di tagliare l'audio.

Struttura OBBLIGATORIA per ogni opera:

1. Se cambia la sala rispetto all'opera precedente, scrivi:
Sala [Nome della Sala]

2. Poi inizia l'opera con questi due marcatori precisi:
Titolo opera [Titolo esatto]
Autore dell'opera [Nome Autore]

3. [Inserisci qui il testo descrittivo dell'opera...]

4. Chiudi l'opera ESATTAMENTE così:
Fine descrizione [Titolo] di [Autore]

Esempio corretto:
Sala del Colosso
Titolo opera Ratto delle Sabine
Autore dell'opera Giambologna
Questa statua rappresenta...
Fine descrizione Ratto delle Sabine di Giambologna

Inizia e finisci l'intera guida con:
Introduzione
[Testo intro]
Fine introduzione
...opere...`;
            
            navigator.clipboard.writeText(prompt);
            alert("Prompt copiato! Incollalo nella tua AI preferita.");
        };
    });
</script>

<div id="editorModal" class="modal-overlay" onclick="window.app.closeModals()">
    <div class="modal-sheet" onclick="event.stopPropagation()">
        <h3 style="margin-top:0">Modifica Opera</h3>
        <input type="hidden" id="editId">
        <div class="input-group"><label>Immagine HD (URL)</label><input type="text" id="editImg"></div>
        <div class="input-group"><label>Titolo</label><input type="text" id="editTitle"></div>
        <div class="input-group"><label>Autore</label><input type="text" id="editAuthor"></div>
        <div class="input-group"><label>Sala / Area Museo</label><input type="text" id="editRoom" placeholder="es. Sala del Colosso"></div>
        
        <button class="btn-main" onclick="window.app.saveTrack()">Salva Modifiche</button>
        <button class="btn-main" style="background:#ff3b30; margin-top:10px;" onclick="window.app.downloadJson()">Esporta JSON</button>
    </div>
</div>

<div id="exploreModal" class="modal-overlay" onclick="window.app.closeModals()">
    <div class="modal-sheet" onclick="event.stopPropagation()">
        <h3 style="margin-top:0">Esplora Guide</h3>
        <div id="guideList"></div>
    </div>
</div>

<script>
    const CATALOG_URL = 'index.json'; 

    window.app = {
        currentData: null,
        player: document.getElementById('audioPlayer'),

        init: async function() {
            this.setupPlayer();
            try {
                const res = await fetch(CATALOG_URL);
                const catalog = await res.json();
                this.renderCatalog(catalog);
                this.fetchGuide(catalog[Math.floor(Math.random()*catalog.length)].url);
            } catch (e) {
                // Fallback su GitHub se index.json non raggiungibile
                this.fetchGuide('https://fabiusai.github.io/audioguide/Galleria_Accademia.json');
            }
        },

        getFreshUrl: function(url) {
            if (!url) return '';
            if (url.startsWith('data:')) return url;
            const separator = url.includes('?') ? '&' : '?';
            return `${url}${separator}t=${new Date().getTime()}`;
        },

        renderCatalog: function(cat) {
            document.getElementById('guideList').innerHTML = cat.map(g => `
                <div style="padding:18px; border-bottom:1px solid #f2f2f7; font-weight:600;" onclick="window.app.fetchGuide('${g.url}')">${g.title}</div>
            `).join('');
        },

        fetchGuide: async function(url) {
            const res = await fetch(url);
            this.renderGuide(await res.json());
            this.closeModals();
        },

        renderGuide: function(data) {
            this.currentData = data;
            this.player.src = data.mp3File;
            const container = document.getElementById('trackList');
            const placeholderImg = "https://via.placeholder.com/800x1200/e5e5ea/8e8e93?text=Nessuna+Immagine";
            
            // Raggruppa le tracce per sala
            const rooms = {};
            data.tracks.forEach(t => {
                const roomName = t.room || "Percorso Generale";
                if (!rooms[roomName]) rooms[roomName] = [];
                rooms[roomName].push(t);
            });

            // Genera HTML raggruppato
            container.innerHTML = Object.keys(rooms).map(roomName => `
                <div class="room-group">
                    <div class="room-header"><i class="fas fa-map-marker-alt"></i> ${roomName}</div>
                    ${rooms[roomName].map(t => {
                        // Calcolo durata
                        const sec = this.toSec(t.end) - this.toSec(t.start);
                        const duration = Math.floor(sec / 60) + ":" + (sec % 60).toString().padStart(2, '0');
                        
                        return `
                        <div class="track-card" id="track-${t.id}">
                            <button class="btn-icon edit-mode-only" style="position:absolute; top:12px; right:12px; z-index:10; background:rgba(255,255,255,0.9);" onclick="window.app.openEditor(${t.id})"><i class="fas fa-pen"></i></button>
                            <div class="track-img-container" onclick="window.app.playTrack(${t.id})">
                                <img src="${t.image ? this.getFreshUrl(t.image) : placeholderImg}" class="track-img" onerror="this.src='${placeholderImg}'">
                            </div>
                            <div class="track-content" onclick="window.app.playTrack(${t.id})">
                                <div class="track-info-text">
                                    <p class="track-title">${t.title}</p>
                                    <div class="track-author">
                                        <span>${t.author}</span>
                                        ${t.room ? `<span class="badge-room" style="margin-left:8px;">${t.room}</span>` : ''}
                                    </div>
                                </div>
                                <div class="track-duration">${duration}</div>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `).join('');
        },

        search: function(query) {
            const term = query.toLowerCase();
            // Cerca in tutte le tracce e nascondi/mostra in base all'ID univoco
            this.currentData.tracks.forEach(t => {
                const card = document.getElementById(`track-${t.id}`);
                if (card) {
                    const match = t.title.toLowerCase().includes(term) || t.author.toLowerCase().includes(term);
                    card.style.display = match ? 'block' : 'none';
                }
            });
            
            // Nascondi le intestazioni delle sale se non hanno tracce visibili (Opzionale, ma elegante)
            document.querySelectorAll('.room-group').forEach(group => {
                const visibleCards = Array.from(group.querySelectorAll('.track-card')).some(c => c.style.display !== 'none');
                group.querySelector('.room-header').style.display = visibleCards ? 'flex' : 'none';
            });
        },

        playTrack: function(id) {
            const t = this.currentData.tracks.find(x => x.id === id);
            this.activeEndSec = this.toSec(t.end);
            this.player.currentTime = this.toSec(t.start);
            this.player.play();
            document.getElementById('npTitle').textContent = t.title;
            document.querySelectorAll('.track-card').forEach(c => c.classList.remove('active'));
            const activeCard = document.getElementById('track-'+id);
            if(activeCard) activeCard.classList.add('active');
        },

        togglePlay: function() {
            if (this.player.paused) this.player.play(); else this.player.pause();
        },

        setupPlayer: function() {
            const btn = document.getElementById('playBtn');
            this.player.onplay = () => btn.innerHTML = '<i class="fas fa-pause"></i>';
            this.player.onpause = () => btn.innerHTML = '<i class="fas fa-play"></i>';
            this.player.ontimeupdate = () => {
                if (this.activeEndSec && this.player.currentTime >= this.activeEndSec) this.player.pause();
            };
        },

        openPromptTool: function() { document.getElementById('promptModal').classList.add('active'); },
        
        openEditor: function(id) {
            const t = this.currentData.tracks.find(x => x.id === id);
            document.getElementById('editId').value = id;
            document.getElementById('editTitle').value = t.title;
            document.getElementById('editAuthor').value = t.author;
            document.getElementById('editRoom').value = t.room || ''; // Carica la sala
            document.getElementById('editImg').value = t.image;
            document.getElementById('editorModal').classList.add('active');
        },
        
        toggleExplore: function() { document.getElementById('exploreModal').classList.toggle('active'); },
        closeModals: function() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); },

        generatePrompt: function() {
            const title = document.getElementById('pTitle').value || "guida";
            const text = document.getElementById('pTranscript').value;
            // Prompt aggiornato per chiedere le Sale
            const prompt = `Converti il seguente testo in JSON per audioguida. 
Struttura richiesta: { "title": "${title}", "mp3File": "audio.mp3", "tracks": [...] }.
Ogni traccia DEVE avere: id, title, author, start, end, image e il nuovo campo "room".
IMPORTANTE: Per il campo "room", usa la tua conoscenza per capire in quale sala del museo si trova l'opera (es. "Sala del Colosso", "Tribuna", "Gipsoteca").
Testo da analizzare: ${text}`;
            navigator.clipboard.writeText(prompt);
            alert("Prompt con istruzioni sulle SALE copiato!");
        },

        saveTrack: function() {
            const id = parseInt(document.getElementById('editId').value);
            const t = this.currentData.tracks.find(x => x.id === id);
            t.title = document.getElementById('editTitle').value;
            t.author = document.getElementById('editAuthor').value;
            t.room = document.getElementById('editRoom').value; // Salva la sala
            t.image = document.getElementById('editImg').value;
            this.renderGuide(this.currentData);
            this.closeModals();
        },

        downloadJson: function() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.currentData, null, 2));
            const a = document.createElement('a'); a.href = dataStr; a.download = "guida.json"; a.click();
        },
        toSec: function(s) { const p = s.split(':'); return parseInt(p[0])*60 + parseInt(p[1]); }
    };

    window.app.init();
</script>
</body>
</html>
