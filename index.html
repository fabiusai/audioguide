<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Audioguide AI Pro</title>
    <link rel="icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="audioguide.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-apple: #007aff;
            --background-light: #f2f2f7;
            --surface-card: #ffffff;
            --text-dark: #1c1c1e;
            --text-medium: #48484a; /* Grigio più scuro per miglior leggibilità */
            --text-light: #8e8e93;
            --border-light: rgba(0,0,0,0.08);
            --radius-lg: 20px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; font-family: -apple-system, system-ui, sans-serif;
            background-color: var(--background-light); color: var(--text-dark);
            padding-bottom: 220px; -webkit-font-smoothing: antialiased;
        }

        .edit-mode-only { display: none !important; }
        body.is-editing .edit-mode-only { display: flex !important; }

        /* --- HEADER & SEARCH --- */
        .sticky-nav {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255, 255, 255, 0.8); backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--border-light);
        }
        header { padding: 15px 20px 10px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 700; letter-spacing: -0.5px; }

        .search-container { padding: 0 20px 15px; }
        .search-wrapper {
            position: relative; background: rgba(118, 118, 128, 0.12);
            border-radius: 10px; display: flex; align-items: center; padding: 8px 12px;
        }
        .search-wrapper i { color: var(--text-light); margin-right: 8px; }
        .search-wrapper input {
            border: none; background: transparent; width: 100%; outline: none;
            font-size: 1rem; color: var(--text-dark);
        }

        .btn-icon {
            background: #e5e5ea; border: none; width: 36px; height: 36px;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
            color: var(--text-dark); transition: 0.2s;
        }

        /* --- CARD LIST --- */
        .container { max-width: 500px; margin: 0 auto; padding: 15px; }
        
        .track-card {
            background: var(--surface-card); border-radius: var(--radius-lg);
            margin-bottom: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.06);
            overflow: hidden; border: 1px solid var(--border-light);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .track-card:active { transform: scale(0.97); }
        .track-card.active { border: 2px solid var(--primary-apple); }

        .track-img-container { width: 100%; height: 320px; background: #d1d1d6; overflow: hidden; }
        
        /* Focus sulla parte superiore per immagini verticali */
        .track-img { 
            width: 100%; height: 100%; object-fit: cover; 
            object-position: top; 
        }
        
        .track-content { padding: 16px; display: flex; justify-content: space-between; align-items: center; }
        .track-info-text { flex-grow: 1; }
        .track-title { font-weight: 700; font-size: 1.1rem; margin: 0; letter-spacing: -0.3px; }
        
        /* Autore più visibile */
        .track-author { 
            font-size: 0.95rem; /* Aumentato da 0.85rem */
            color: var(--text-medium); /* Grigio più scuro */
            margin-top: 4px; 
            font-weight: 500; /* Leggermente più spesso */
        }
        
        .track-duration { font-size: 0.8rem; font-weight: 600; color: var(--primary-apple); }

        /* --- PLAYER --- */
        .player-bar {
            position: fixed; bottom: 0; width: 100%;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(25px);
            padding: 20px 25px 40px; border-top: 1px solid var(--border-light);
            z-index: 500;
        }
        .np-title { text-align: center; font-weight: 600; font-size: 0.9rem; margin-bottom: 15px; }
        .player-controls { display: flex; justify-content: center; align-items: center; gap: 35px; }
        .play-btn { 
            width: 65px; height: 65px; background: var(--text-dark); color: white; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;
        }

        /* --- MODALS --- */
        .modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); 
            z-index: 1000; align-items: flex-end;
        }
        .modal-sheet {
            background: white; width: 100%; border-radius: 24px 24px 0 0;
            padding: 25px; transform: translateY(100%); transition: transform 0.3s ease-out;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-overlay.active { display: flex; }
        .modal-overlay.active .modal-sheet { transform: translateY(0); }

        .input-group { margin-bottom: 18px; }
        .input-group label { display: block; font-size: 0.75rem; font-weight: 700; color: var(--text-light); margin-bottom: 6px; text-transform: uppercase; }
        .input-group input, .input-group textarea {
            width: 100%; padding: 14px; border: none; background: #f2f2f7; border-radius: 12px; font-size: 1rem;
        }
        .btn-main { background: var(--primary-apple); color: white; border: none; padding: 16px; width: 100%; border-radius: 14px; font-weight: 700; cursor: pointer; }
    </style>
</head>
<body>

<div class="sticky-nav">
    <header>
        <div class="header-top">
            <h1>Audioguide AI</h1>
            <div style="display: flex; gap: 12px;">
                <button class="btn-icon edit-mode-only" style="background: #fff9c4;" onclick="window.app.openPromptTool()"><i class="fas fa-sparkles"></i></button>
                <button class="btn-icon" onclick="window.app.toggleExplore()"><i class="fas fa-compass"></i></button>
                <button class="btn-icon" onclick="document.body.classList.toggle('is-editing')"><i class="fas fa-pencil-alt"></i></button>
            </div>
        </div>
    </header>
    <div class="search-container">
        <div class="search-wrapper">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Cerca opera o autore..." oninput="window.app.search(this.value)">
        </div>
    </div>
</div>

<div class="container" id="trackList"></div>

<div class="player-bar">
    <div id="npTitle" class="np-title">Scegli un'opera</div>
    <div class="player-controls">
        <button class="btn-icon" style="background:none" onclick="document.getElementById('audioPlayer').currentTime -= 10"><i class="fas fa-undo-alt fa-lg"></i></button>
        <div class="play-btn" id="playBtn" onclick="window.app.togglePlay()"><i class="fas fa-play"></i></div>
        <button class="btn-icon" style="background:none" onclick="document.getElementById('audioPlayer').currentTime += 10"><i class="fas fa-redo-alt fa-lg"></i></button>
    </div>
    <audio id="audioPlayer" style="display:none;"></audio>
</div>

<div id="promptModal" class="modal-overlay" onclick="window.app.closeModals()">
    <div class="modal-sheet" onclick="event.stopPropagation()">
        <h3 style="margin-top:0">✨ Generatore Prompt AI</h3>
        <div class="input-group"><label>Titolo Guida</label><input type="text" id="pTitle"></div>
        <div class="input-group"><label>Testo Sorgente</label><textarea id="pTranscript" rows="5"></textarea></div>
        <button class="btn-main" onclick="window.app.generatePrompt()">Copia Prompt</button>
    </div>
</div>

<div id="editorModal" class="modal-overlay" onclick="window.app.closeModals()">
    <div class="modal-sheet" onclick="event.stopPropagation()">
        <h3 style="margin-top:0">Modifica Opera</h3>
        <input type="hidden" id="editId">
        <div class="input-group"><label>Immagine HD (URL)</label><input type="text" id="editImg"></div>
        <div class="input-group"><label>Titolo</label><input type="text" id="editTitle"></div>
        <div class="input-group"><label>Autore</label><input type="text" id="editAuthor"></div>
        <button class="btn-main" onclick="window.app.saveTrack()">Salva Modifiche</button>
        <button class="btn-main" style="background:#ff3b30; margin-top:10px;" onclick="window.app.downloadJson()">Esporta JSON</button>
    </div>
</div>

<div id="exploreModal" class="modal-overlay" onclick="window.app.closeModals()">
    <div class="modal-sheet" onclick="event.stopPropagation()">
        <h3 style="margin-top:0">Esplora Guide</h3>
        <div id="guideList"></div>
    </div>
</div>

<script>
    const CATALOG_URL = 'index.json'; 

    window.app = {
        currentData: null,
        player: document.getElementById('audioPlayer'),

        init: async function() {
            this.setupPlayer();
            try {
                const res = await fetch(CATALOG_URL);
                const catalog = await res.json();
                this.renderCatalog(catalog);
                this.fetchGuide(catalog[Math.floor(Math.random()*catalog.length)].url);
            } catch (e) {
                this.renderGuide({ title: "Demo", mp3File: "", tracks: [{ id: 1, title: "Il David", author: "Michelangelo", start: "00:00", end: "00:30", image: "https://images.unsplash.com/photo-1549880338-65ddcdfd017b?q=80&w=1200" }] });
            }
        },

        getFreshUrl: function(url) {
            if (!url) return '';
            if (url.startsWith('data:')) return url;
            const separator = url.includes('?') ? '&' : '?';
            return `${url}${separator}t=${new Date().getTime()}`;
        },

        renderCatalog: function(cat) {
            document.getElementById('guideList').innerHTML = cat.map(g => `
                <div style="padding:18px; border-bottom:1px solid #f2f2f7; font-weight:600;" onclick="window.app.fetchGuide('${g.url}')">${g.title}</div>
            `).join('');
        },

        fetchGuide: async function(url) {
            const res = await fetch(url);
            this.renderGuide(await res.json());
            this.closeModals();
        },

        renderGuide: function(data) {
            this.currentData = data;
            this.player.src = data.mp3File;
            const container = document.getElementById('trackList');
            container.innerHTML = data.tracks.map(t => `
                <div class="track-card" id="track-${t.id}">
                    <button class="btn-icon edit-mode-only" style="position:absolute; top:12px; right:12px; z-index:10; background:rgba(255,255,255,0.9);" onclick="window.app.openEditor(${t.id})"><i class="fas fa-pen"></i></button>
                    <div class="track-img-container" onclick="window.app.playTrack(${t.id})">
                        <img src="${this.getFreshUrl(t.image)}" class="track-img" onerror="this.src='https://via.placeholder.com/800x1200?text=Immagine+non+disponibile'">
                    </div>
                    <div class="track-content" onclick="window.app.playTrack(${t.id})">
                        <div class="track-info-text">
                            <p class="track-title">${t.title}</p>
                            <p class="track-author">${t.author}</p>
                        </div>
                        <div class="track-duration">${t.start}</div>
                    </div>
                </div>
            `).join('');
        },

        search: function(query) {
            const term = query.toLowerCase();
            const cards = document.querySelectorAll('.track-card');
            this.currentData.tracks.forEach((t, idx) => {
                const match = t.title.toLowerCase().includes(term) || t.author.toLowerCase().includes(term);
                cards[idx].style.display = match ? 'block' : 'none';
            });
        },

        playTrack: function(id) {
            const t = this.currentData.tracks.find(x => x.id === id);
            this.activeEndSec = this.toSec(t.end);
            this.player.currentTime = this.toSec(t.start);
            this.player.play();
            document.getElementById('npTitle').textContent = t.title;
            document.querySelectorAll('.track-card').forEach(c => c.classList.remove('active'));
            document.getElementById('track-'+id).classList.add('active');
        },

        togglePlay: function() {
            if (this.player.paused) this.player.play(); else this.player.pause();
        },

        setupPlayer: function() {
            const btn = document.getElementById('playBtn');
            this.player.onplay = () => btn.innerHTML = '<i class="fas fa-pause"></i>';
            this.player.onpause = () => btn.innerHTML = '<i class="fas fa-play"></i>';
            this.player.ontimeupdate = () => {
                if (this.activeEndSec && this.player.currentTime >= this.activeEndSec) this.player.pause();
            };
        },

        openPromptTool: function() { document.getElementById('promptModal').classList.add('active'); },
        openEditor: function(id) {
            const t = this.currentData.tracks.find(x => x.id === id);
            document.getElementById('editId').value = id;
            document.getElementById('editTitle').value = t.title;
            document.getElementById('editAuthor').value = t.author;
            document.getElementById('editImg').value = t.image;
            document.getElementById('editorModal').classList.add('active');
        },
        toggleExplore: function() { document.getElementById('exploreModal').classList.toggle('active'); },
        closeModals: function() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); },

        generatePrompt: function() {
            const title = document.getElementById('pTitle').value || "guida";
            const text = document.getElementById('pTranscript').value;
            const prompt = `Converti in JSON per audioguida: { "title": "${title}", "mp3File": "audio.mp3", "tracks": [...] }. Testo: ${text}`;
            navigator.clipboard.writeText(prompt);
            alert("Prompt copiato!");
        },

        saveTrack: function() {
            const id = parseInt(document.getElementById('editId').value);
            const t = this.currentData.tracks.find(x => x.id === id);
            t.title = document.getElementById('editTitle').value;
            t.author = document.getElementById('editAuthor').value;
            t.image = document.getElementById('editImg').value;
            this.renderGuide(this.currentData);
            this.closeModals();
        },

        downloadJson: function() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.currentData, null, 2));
            const a = document.createElement('a'); a.href = dataStr; a.download = "guida.json"; a.click();
        },
        toSec: function(s) { const p = s.split(':'); return parseInt(p[0])*60 + parseInt(p[1]); }
    };

    window.app.init();
</script>
</body>
</html>
