<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Audioguida Pro - Musei</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-apple: #007aff;
            --background-light: #f2f2f7;
            --surface-card: #ffffff;
            --text-dark: #1c1c1e;
            --text-medium: #48484a;
            --text-light: #8e8e93;
            --border-light: rgba(0,0,0,0.08);
            --radius-lg: 20px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; font-family: -apple-system, system-ui, sans-serif;
            background-color: var(--background-light); color: var(--text-dark);
            padding-bottom: 240px;
        }

        header {
            padding: 40px 20px 20px; background: var(--surface-card);
            border-bottom: 1px solid var(--border-light);
        }
        h1 { font-size: 28px; font-weight: 700; margin: 0; letter-spacing: -0.5px; }

        /* Stili per le Sale (Nuovi) */
        .room-section { margin-top: 30px; padding: 0 16px; }
        .room-header { 
            font-size: 0.85rem; font-weight: 800; color: var(--primary-apple);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px;
            display: flex; align-items: center; gap: 8px;
            padding-left: 5px; border-left: 3px solid var(--primary-apple);
        }

        .track-list { display: flex; flex-direction: column; gap: 16px; }
        .track-card {
            background: var(--surface-card); border-radius: var(--radius-lg);
            overflow: hidden; display: flex; height: 110px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative;
        }
        .track-img-container { width: 110px; height: 110px; flex-shrink: 0; }
        .track-img { width: 100%; height: 100%; object-fit: cover; }
        .track-content { 
            padding: 12px 16px; flex-grow: 1; display: flex; 
            flex-direction: column; justify-content: space-between;
        }
        .track-title { font-size: 17px; font-weight: 600; margin: 0; margin-bottom: 2px; }
        
        .track-meta { display: flex; justify-content: space-between; align-items: flex-end; }
        .author-info { display: flex; flex-direction: column; gap: 2px; }
        .track-author { font-size: 14px; color: var(--text-medium); }
        .badge-room { 
            font-size: 0.65rem; background: #e5e5ea; padding: 2px 6px; 
            border-radius: 4px; color: var(--text-medium); font-weight: 700; width: fit-content;
        }
        .track-duration { font-size: 13px; color: var(--text-light); font-variant-numeric: tabular-nums; }

        /* Player fisso */
        .player-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-light); padding: 20px; z-index: 100;
        }
        audio { width: 100%; height: 40px; margin-bottom: 10px; }
        .now-playing { font-size: 14px; font-weight: 600; text-align: center; margin-bottom: 8px; }

        /* Modali ed Editor */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal-content { 
            background: white; width: 90%; max-width: 500px; padding: 25px;
            border-radius: 20px; max-height: 80vh; overflow-y: auto;
        }
        input, textarea { 
            width: 100%; padding: 12px; margin: 10px 0; 
            border: 1px solid #ddd; border-radius: 10px; font-size: 16px;
        }
        .btn { 
            padding: 12px 20px; border-radius: 12px; border: none; 
            font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .btn-primary { background: var(--primary-apple); color: white; width: 100%; }
        .btn-icon { background: none; border: none; color: var(--primary-apple); font-size: 1.2rem; }
        
        .admin-controls { display: flex; gap: 10px; padding: 10px 20px; background: #eee; }
        .edit-mode-only { display: none; }
        body.edit-mode .edit-mode-only { display: block; }
    </style>
</head>
<body>

<header>
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1 id="guideTitle">Carica Guida...</h1>
        <button class="btn-icon" onclick="window.app.toggleAdmin()"><i class="fas fa-cog"></i></button>
    </div>
</header>

<div class="admin-controls edit-mode-only">
    <button class="btn" onclick="document.getElementById('fileInput').click()">Carica JSON</button>
    <button class="btn" onclick="window.app.toggleModal('promptModal')">Generatore Prompt</button>
    <button class="btn" onclick="window.app.downloadJson()">Esporta</button>
    <input type="file" id="fileInput" hidden accept=".json" onchange="window.app.loadJson(event)">
</div>

<div id="trackList">
    </div>

<div class="player-bar">
    <div class="now-playing" id="nowPlaying">Seleziona una traccia</div>
    <audio id="mainPlayer" controls></audio>
</div>

<div id="promptModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Generatore Prompt AI</h3>
        <input type="text" id="pTitle" placeholder="Titolo Museo (es. Galleria Accademia)">
        <textarea id="pTranscript" rows="6" placeholder="Incolla qui la trascrizione dell'audio..."></textarea>
        <button class="btn btn-primary" onclick="window.app.generatePrompt()">Copia Prompt Potenziato</button>
        <button class="btn" onclick="window.app.toggleModal('promptModal')">Chiudi</button>
    </div>
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Modifica Traccia</h3>
        <input type="hidden" id="editId">
        <label>Titolo Opera</label><input type="text" id="editTitle">
        <label>Autore</label><input type="text" id="editAuthor">
        <label>Sala/Area (Nuovo)</label><input type="text" id="editRoom" placeholder="es. Sala del Colosso">
        <label>URL Immagine</label><input type="text" id="editImg">
        <button class="btn btn-primary" onclick="window.app.saveTrack()">Salva Modifiche</button>
        <button class="btn" onclick="window.app.toggleModal('editModal')">Annulla</button>
    </div>
</div>

<script>
    window.app = {
        currentData: null,
        player: document.getElementById('mainPlayer'),

        toggleAdmin: function() {
            document.body.classList.toggle('edit-mode');
        },

        toggleModal: function(id) {
            document.getElementById(id).classList.toggle('active');
        },

        loadJson: function(e) {
            const reader = new FileReader();
            reader.onload = (event) => {
                this.currentData = JSON.parse(event.target.result);
                this.renderGuide(this.currentData);
            };
            reader.readAsText(e.target.files[0]);
        },

        renderGuide: function(data) {
            document.getElementById('guideTitle').innerText = data.title;
            this.player.src = data.mp3File;
            const container = document.getElementById('trackList');
            
            // Raggruppamento tracce per sala
            const rooms = {};
            data.tracks.forEach(t => {
                const roomName = t.room || "Percorso Generale";
                if (!rooms[roomName]) rooms[roomName] = [];
                rooms[roomName].push(t);
            });

            container.innerHTML = Object.keys(rooms).map(roomName => `
                <div class="room-section">
                    <div class="room-header"><i class="fas fa-map-marker-alt"></i> ${roomName}</div>
                    <div class="track-list">
                        ${rooms[roomName].map(t => `
                            <div class="track-card" id="track-${t.id}">
                                <button class="btn-icon edit-mode-only" style="position:absolute; top:8px; right:8px; z-index:10; background:white; border-radius:50%; width:30px; height:30px; font-size:0.8rem; box-shadow:0 2px 5px rgba(0,0,0,0.1);" onclick="window.app.openEditor(${t.id})"><i class="fas fa-pen"></i></button>
                                <div class="track-img-container" onclick="window.app.playTrack(${t.id})">
                                    <img src="${t.image}" class="track-img" onerror="this.src='https://via.placeholder.com/200x200?text=Immagine'">
                                </div>
                                <div class="track-content" onclick="window.app.playTrack(${t.id})">
                                    <div class="track-info-text">
                                        <p class="track-title">${t.title}</p>
                                        <div class="author-info">
                                            <span class="track-author">${t.author || 'Artista Sconosciuto'}</span>
                                            ${t.room ? `<span class="badge-room">${t.room}</span>` : ''}
                                        </div>
                                    </div>
                                    <div class="track-meta">
                                        <div class="track-duration">${t.start}</div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        },

        playTrack: function(id) {
            const track = this.currentData.tracks.find(t => t.id === id);
            document.getElementById('nowPlaying').innerText = track.title;
            const startTime = this.toSec(track.start);
            this.player.currentTime = startTime;
            this.player.play();
        },

        openEditor: function(id) {
            const t = this.currentData.tracks.find(x => x.id === id);
            document.getElementById('editId').value = t.id;
            document.getElementById('editTitle').value = t.title;
            document.getElementById('editAuthor').value = t.author || '';
            document.getElementById('editRoom').value = t.room || '';
            document.getElementById('editImg').value = t.image;
            this.toggleModal('editModal');
        },

        saveTrack: function() {
            const id = parseInt(document.getElementById('editId').value);
            const t = this.currentData.tracks.find(x => x.id === id);
            t.title = document.getElementById('editTitle').value;
            t.author = document.getElementById('editAuthor').value;
            t.room = document.getElementById('editRoom').value;
            t.image = document.getElementById('editImg').value;
            this.renderGuide(this.currentData);
            this.toggleModal('editModal');
        },

        generatePrompt: function() {
            const title = document.getElementById('pTitle').value || "Museo";
            const text = document.getElementById('pTranscript').value;
            const prompt = `Analizza il testo per creare un file JSON per un'audioguida. 
Struttura: { "title": "${title}", "mp3File": "audio.mp3", "tracks": [...] }
Ogni traccia deve avere: id, title, author, start, end, image e il campo "room".
PER IL CAMPO "room": Ricerca sul web o usa la tua conoscenza per identificare in quale SALA o AREA del museo si trova l'opera citata (es. "Sala del Colosso", "Tribuna del David"). Se non trovi la sala, usa "Percorso Generale".
Testo: ${text}`;
            
            navigator.clipboard.writeText(prompt);
            alert("Prompt con gestione SALE copiato in memoria!");
        },

        downloadJson: function() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.currentData, null, 2));
            const a = document.createElement('a'); a.href = dataStr; a.download = "guida_aggiornata.json"; a.click();
        },

        toSec: function(s) { 
            const p = s.split(':'); 
            return parseInt(p[0]) * 60 + parseInt(p[1]); 
        }
    };
</script>

</body>
</html>
